var totalData = 0; //ì´ ë°ì´í„° ìˆ˜
var dataPerPage = 6;
var pageCount = 10; //í˜ì´ì§•ì— ë‚˜íƒ€ë‚¼ í˜ì´ì§€ ìˆ˜
var globalCurrentPage = 1; //í˜„ì¬ í˜ì´ì§€
var data_list;
var consultingData = [];
var taskData = [];
const today = new Date().setHours(0, 0, 0, 0);
let make_recobook = function(c){
    if( c == null){
        return 'âŒ'
    } else if(c == 'NOT'){
        result = c + ' (ì¶”ì²œë„ì„œì—†ìŒ)'
        return result
    }else{
        return c
    }
}
let make_reject_code = function(rc){
    if( rc == 0){
        return 'âŒ(ë°˜ë ¤)';
    }else{
        return 'â­•(ìŠ¹ì¸)';
    }
}
let make_date = function(d){
    if(d==null){
        return 'âŒ'
    }
    const date = new Date(d)
    return date.getFullYear()+'-'+(date.getMonth()+ 1).toString().padStart(2, '0')+'-'+date.getDate().toString().padStart(2, '0')
}
let missed_date = function(d){
    const date = new Date(d)
    const standard = new Date('1111-01-01')
    if(date.getTime() == standard.getTime()){
        return "ì—†ìŒ"
    }else if(date.setHours(0, 0, 0, 0) == today){
        return "ì˜¤ëŠ˜"
    }else{
        return date.getFullYear()+'-'+(date.getMonth()+ 1).toString().padStart(2, '0')+'-'+date.getDate().toString().padStart(2, '0')
    }
}
let make_priority = function(priority) {
    if(priority==1) return '';
    else if(priority==2) return 'ì˜¤í›„ì—…ë¬´';
    else if(priority==3) return 'ì˜¤ì „ì—…ë¬´ğŸŒ';
    else return 'ê¸´ê¸‰ì—…ë¬´âš¡';
}
let answer_rate =  function(answer, all) {
    if(Object.is(answer/all, NaN)) return 0;
    else return answer/all*100;
}
let make_semester=function(semester){
    if (semester == 1){
        return 1;
    }else if(semester == 2){
        return 5;
    }else if(semester == 0){
        return 9;
    }else{
        return semester
    }
}
function q_category(category) {
    if (category == 0) {
        category = 'ì¼ë°˜ë¬¸ì˜'
    } else if (category == 1) {
        category = 'í‡´ì†Œë¬¸ì˜'
    } else{
        category = 'ì´ë°˜ë¬¸ì˜'
    }
    return category
}
// ë©”ì¸í™”ë©´ ë°ì´í„° 
function get_data() {
    $.ajax({
        type: "GET",
        url: "/teacher/get_data",
        dataType: 'json',
        data: {},
        success: function (response) {
            if(response['ban_data']=='ì—†ìŒ'){
                // ì˜ˆì™¸ ì²˜ë¦¬ 
            }
            // ë°˜ ì°¨íŠ¸ ë°ì´í„° 
            // ë³¸ì› ë¬¸ì˜ banì„ íƒ ì˜µì…˜ ê°™ì´ ë¶™ì´ê¸° 
            // let switchstudent_t =  response['switchstudent'].length ( ì„ ìƒë‹˜ ê¸°ì¤€ ì´ë°˜ ìœ¨ì— ì‚¬ìš© )
            // let outstudent_t = response['outstudent'].length ( ì„ ìƒë‹˜ ê¸°ì¤€ í‡´ì†Œ ìœ¨ì— ì‚¬ìš© )
            $('#ban_chart_list').empty()
            $('#history_ban').empty()
            let unlearned_t =response['all_consulting'].length > 0 ? response['all_consulting'].filter(consulting => consulting.category_id < 100).length : 0;
            let temp_ban_option = '<option value="none" selected>ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>';
            for (i=0;i< response['ban_data'].length;i++) {
                let register_no =  response['ban_data'][i]['register_no']
                let name =  response['ban_data'][i]['name']
                let semester = make_semester(response['ban_data'][i]['semester'])
                let total_student_num =  response['ban_data'][i]['total_student_num']
                let unlearned_arr = response['all_consulting'].length > 0 ? response['all_consulting'].filter(consulting => consulting.category_id < 100 && consulting.ban_id === register_no): 0;
                let unlearned = 0
                let unlearned_ixl = 0
                let unlearned_reading = 0
                let unlearned_speacial = 0
                let unlearned_writing = 0
                let unlearned_homepage = 0
                let unlearned_intoreading = 0
                if(unlearned_arr != 0){
                    unlearned = unlearned_arr.length;
                    unlearned_ixl = unlearned_arr.filter(a => a.category_id == 1).length
                    unlearned_reading = unlearned_arr.filter(a => a.category_id == 4).length
                    unlearned_speacial = unlearned_arr.filter(a => a.category_id == 3).length
                    unlearned_writing = unlearned_arr.filter(a => a.category_id == 6).length
                    unlearned_homepage = unlearned_arr.filter(a => a.category_id == 2).length
                    unlearned_intoreading = unlearned_arr.filter(a => a.category_id == 5 || a.category_id == 7).length
                }
                let switchstudent =response['switchstudent'].length > 0 ? response['switchstudent'].filter(a=> a.ban_id === register_no).length : 0;
                let outstudent = response['outstudent'].length > 0 ? response['outstudent'].filter(a=> a.ban_id === register_no).length : 0;
                temp_ban_option += `
                <option value=${register_no}>${name} (${semester}ì›” í•™ê¸°)</option>
                `;
                let temp_ban_chart = `
                <div class="d-flex justify-content-start align-items-start flex-column w-100 my-2">
                    <h5 class="mb-3">ğŸ“Œ  ${name} (${semester}ì›” í•™ê¸°)</h5>
                    <div class="row w-100">
                        <div class="chart-wrapper col-sm-5">
                            <canvas id="total-chart-element${i}" class="total-chart-element p-sm-3 p-2"></canvas>
                            <div class ="chart-data-summary">
                                <span>ê´€ë¦¬ì¤‘:${ total_student_num }</span><br>
                                <span>* ì´ë°˜:${ switchstudent }</span><br>
                                <span>* í‡´ì†Œ:${ outstudent }</span>
                            </div>
                        </div>
                        <div class="col-sm-7 d-flex justify-content-center align-items-center">
                            <table class="table text-center" id="class_list">
                                <tbody style="width:100%;">
                                    <tr class="row">
                                        <th class="col-12" data-bs-toggle="modal" data-bs-target="#ban_student_list" onclick="get_student(${register_no})">${name}ë°˜  ì›ìƒ ëª©ë¡  âœ”ï¸</th>
                                    </tr>
                                    <tr class="row">
                                        <th class="col-12">ì´ ë¯¸í•™ìŠµ ${unlearned}ê±´  (${answer_rate(unlearned, unlearned_t).toFixed(2)}%)</th>
                                    </tr>
                                    <tr class="row">
                                    <th class="col-2">IXL</th>
                                    <th class="col-2">ë¦¬ë”©</th>
                                    <th class="col-2">ë¦¬íŠ¹</th>
                                    <th class="col-2">ì¸íˆ¬ë¦¬ë”©</th>
                                    <th class="col-2">ë¼ì´íŒ…</th>
                                    <th class="col-2">ë¯¸ì ‘ì†</th>
                                    </tr>
                                    <tr class="row">
                                    <td class="col-2">${unlearned_ixl}ê±´(${answer_rate(unlearned_ixl, unlearned).toFixed(0)}%)</td>
                                    <td class="col-2">${unlearned_reading}ê±´(${answer_rate(unlearned_reading, unlearned).toFixed(0)}%)</td>
                                    <td class="col-2">${unlearned_speacial}ê±´(${answer_rate(unlearned_speacial, unlearned).toFixed(0)}%)</td>
                                    <td class="col-2">${unlearned_intoreading}ê±´(${answer_rate(unlearned_intoreading, unlearned).toFixed(0)}%)</td>
                                    <td class="col-2">${unlearned_writing}ê±´(${answer_rate(unlearned_writing, unlearned).toFixed(0)}%)</td>
                                    <td class="col-2">${unlearned_homepage}ê±´(${answer_rate(unlearned_homepage, unlearned).toFixed(0)}%)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                `;
                $('#ban_chart_list').append(temp_ban_chart);

                new Chart($((`#total-chart-element${i}`)), {
                    type: 'doughnut',
                    data: {
                        labels: ['ê´€ë¦¬ì¤‘', 'ì´ë°˜', 'í‡´ì†Œ'],
                        datasets: [
                            {
                                data: [total_student_num, switchstudent, outstudent],
                                backgroundColor: ['#B39CD0', '#ffd400', '#F23966'],
                                hoverOffset: 4,
                            },
                        ],
                    },
                    options: {
                        plugins: {
                            legend: {
                                display: false,
                            },
                        },
                    },
                });
            }
            // ë³¸ì› ë¬¸ì˜ banì„ íƒ ì˜µì…˜ ê°™ì´ ë¶™ì´ê¸° 
            $('#my_ban_list').html(temp_ban_option)
            // ìƒë‹´ì¼ì§€ ì¡°íšŒ ban ì„ íƒ ì˜µì…˜ ê°™ì´ ë¶™ì´ê¸° 
            $('#history_ban').append(temp_ban_option)
            
            // let consulting_deadlinemissed = consulting_notdone.length > 0 ? consulting_notdone.filter(c => new Date(c.deadline).setHours(0, 0, 0, 0) < today).length : 0;
            let consulting_t = response['all_consulting'].length;
            let consulting_done = consulting_t != 0 ? response['all_consulting'].filter(consulting => consulting.done === 1).length : 0  
            // let consulting_notdone = consulting_t - consulting_done
            let task_done = response['all_task'].length > 0 ? response['all_task'].filter(task => task.done != 0  && new Date(task.created_at).setHours(0, 0, 0, 0) == today).length : 0;
            let total_task = response['all_task'].length
            let task_notdone = total_task-task_done;
            let temp_report = `
            <td class="col-3"> ${task_done}/${total_task} </td>
            <td class="col-3"> ( ${answer_rate(task_done,total_task).toFixed(0)}% ) </td>
            <td class="col-3"> ${consulting_done}/${consulting_t} </td>
            <td class="col-3"> ( ${answer_rate(consulting_done, consulting_t).toFixed(0)}% ) </td>
            `;
            $('#classreport').html(temp_report)

            // ì˜¤ëŠ˜ì˜ ì—…ë¬´ ë¿Œë ¤ì£¼ê¸° 
            if(task_notdone == 0){
                $('#task_title').html('ì˜¤ëŠ˜ì˜ ì—…ë¬´ ë ğŸ˜†');
                $('#task_button').hide();
            }else{
                $('#task_title').html('ì˜¤ëŠ˜ì˜ ì—…ë¬´ '+task_notdone+'ê±´');
                $('#task_button').show();
            }
                // ì˜¤ëŠ˜ì˜ ì—…ë¬´ ì¤‘ë³µ ì¹´í…Œê³ ë¦¬ë¡œ ë¬¶ê¸° 
            const categoryGrouped = response['all_task'].reduce((result, item) => {
                const category = item.category;
                if (!result[category]) {
                    result[category] = [];
                }
                result[category].push(item);
                return result;
            }, {});

                // ê²°ê³¼ë¥¼ ê°ì²´ì˜ ë°°ì—´ë¡œ ë³€í™˜
            const categoryGroupedresult = Object.entries(categoryGrouped).map(([category, items]) => {
                return { [category]: items };
            });

            let temp_cate_menu = ''
            for(i=0; i < categoryGroupedresult.length; i++){
                const category = Object.keys(categoryGroupedresult[i])[0];
                // const items = categoryGroupedresult[i][category].filter( e => e.done === 0 );
                const items = categoryGroupedresult[i][category];
                
                items.sort((a, b) => b.priority - a.priority);
                const contentsGrouped = items.reduce((result, item) => {
                    const contents = item.contents;
                    const priority = item.priority;
                    const deadline = item.deadline;
                    const doc = {
                        'id':item.id,
                        'ban_id':item.ban_id,
                        'done':item.done,
                        'created_at':new Date(item.created_at).setHours(0, 0, 0, 0)
                    }
                    const key =  priority + '_' + contents + '_' + deadline;
                    if (!result[key]) {
                        result[key] = [];
                    }
                    result[key].push(doc);
                    return result;
                }, {});

                // ê²°ê³¼ë¥¼ ê°ì²´ì˜ ë°°ì—´ë¡œ ë³€í™˜
                const contentsGroupedresult = Object.entries(contentsGrouped).map(([key, items]) => {
                    return { [key]: items };
                });
                temp_cate_menu += `
                <thead  style="background-color:#ffc107;">
                    <tr class="row">
                    <th class="col-2">< ì—…ë¬´ìˆœì„œ</th>
                    <th class="col-8">${category}ì—…ë¬´</th>
                    <th class="col-2">ë§ˆê°ì¼ ></th>
                    </tr>
                </thead>
                <tbody style="width:100%;">  
                `;

                if (contentsGroupedresult && contentsGroupedresult.length > 0) {
                    for(j=0; j < contentsGroupedresult.length; j++){
                        const contents = Object.keys(contentsGroupedresult[j])[0];
                        task_items = contentsGroupedresult[j][contents];
                        const v = contents.split('_')
                        temp_cate_menu += `
                            <tr class="row">
                                <td class="col-2">${make_priority(v[0])}</td>
                                <td class="col-8">${v[1]}</td>
                                <td class="col-2">${make_date(v[2])}</td>
                            </tr>
                            <td class="col-12">`;
                            for(k=0; k < task_items.length; k++){
                                const ban_name = response['ban_data'].filter(a => a.register_no === task_items[k].ban_id)[0]['name']
                                if(task_items[k].done == 0){
                                    temp_cate_menu += `
                                    <label><input type="checkbox" name="taskid" value="${task_items[k].id}"/>${ban_name}</label>`;
                                }else if(task_items[k].done == 1 && task_items[k].created_at == today){
                                    temp_cate_menu += `
                                    <label class="done">âœ… ${ban_name}</label>`;
                                }
                            }
                            temp_cate_menu += `</td></tbody>`;
                    }
                } else {
                    temp_cate_menu += `
                        <tr class="row">
                            <td class="col-12">í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                    `;
                }

                temp_cate_menu += `</tbody>`;
            }
            $('#cate_menu').html(temp_cate_menu);
            
            // ìƒë‹´ ëª©ë¡ 
            let result = response['my_students'].reduce((acc, student) => {
                const consultingList = response['all_consulting'].filter(c => c.student_id === student.register_no);
                if (consultingList.length > 0) {
                    const todoconsulting = consultingList.filter(c => c.done === 0)
                    if(todoconsulting.length > 0 ){
                        const deadline = todoconsulting.reduce((prev, current) => {
                            let prevDueDate = make_date(prev.deadline);
                            let currentDueDate = make_date(current.deadline);
                            return currentDueDate < prevDueDate ? current : prev;
                        }, todoconsulting[0]);
                        const missed = todoconsulting.reduce((prev, current) => {
                            let prevDueDate = make_date(prev.missed);
                            let currentDueDate = make_date(current.missed);
                            return currentDueDate < prevDueDate ? prev : current;
                        }, todoconsulting[0]);
    
                        acc.push({
                            'teacher_id':student.id,
                            'student_id': student.register_no,
                            'student_name': student.name +'('+student.nick_name+')',
                            'student_mobileno': student.mobileno,
                            'student_reco_book_code': make_recobook(student.reco_book_code),
                            'ban_id': student.ban_id,
                            'ban_name': student.classname,
                            'consulting_num': todoconsulting.length,
                            'done_consulting_num': consultingList.length - todoconsulting.length,
                            'deadline': make_date(deadline.deadline),
                            'missed' : missed_date(missed.missed),
                            'consulting_list': consultingList
                        });
                    }else{
                        acc.push({
                            'teacher_id':student.id,
                            'student_id': student.register_no,
                            'student_name': student.name +'('+student.nick_name+')',
                            'student_mobileno': student.mobileno,
                            'student_reco_book_code': make_recobook(student.reco_book_code),
                            'ban_id': student.ban_id,
                            'ban_name': student.classname,
                            'consulting_num': 0,
                            'done_consulting_num': consultingList.length,
                            'deadline': make_date('3000-01-01'),
                            'missed' : missed_date('1111-01-01'),
                            'consulting_list': consultingList
                        });
                    }
                }else{
                    acc.push({
                        'teacher_id':student.id,
                        'student_id': student.register_no,
                        'student_name': student.name +'('+student.nick_name+')',
                        'student_mobileno': student.mobileno,
                        'student_reco_book_code': make_recobook(student.reco_book_code),
                        'ban_id': student.ban_id,
                        'ban_name': student.classname,
                        'consulting_num': 0,
                        'done_consulting_num': 0,
                        'deadline': make_date('3000-01-01'),
                        'missed' : missed_date('1111-01-01'),
                        'consulting_list': []
                    });
                }
                return acc;
            }, []);
            if (result.length > 0) {
                result = result.sort((a, b) => {
                    return b.consulting_num - a.consulting_num;
                });
                result = result.sort((a, b) => {
                    return a.deadline - b.deadline
                });
                consultingStudentData = result
                get_consulting_student(0)
            } else {
                $('#today_consulting_title').html($('#today_consulting_title').html()+'   0ê±´');
                $('#consulting_student_list').hide();
                $('#consultingstudent_pagination').hide();
            }
        },
        error:function(xhr, status, error){
                alert('xhr.responseText');
        }
    });
}
function displayData(totalData, currentPage, dataPerPage,data_list,b_id) {
    let chartHtml = "";

    //Numberë¡œ ë³€í™˜í•˜ì§€ ì•Šìœ¼ë©´ ì•„ë˜ì—ì„œ +ë¥¼ í•  ê²½ìš° ìŠ¤íŠ¸ë§ ê²°í•©ì´ ë˜ì–´ë²„ë¦¼.. 
    currentPage = Number(currentPage);
    dataPerPage = Number(dataPerPage);
    let last_item = (currentPage - 1) * dataPerPage + dataPerPage;
    if( last_item > totalData){
        last_item = totalData
    }
    for (
        var i = (currentPage - 1) * dataPerPage; //11*5 = 55
        i < last_item; // 55+5
        i++
    ) {
        target = data_list[i]
        let register_no = target['student_id']
        let name = target['student_name'];
        let mobileno = target['mobileno'];
        let parent_name_mobileno = target['pname'] +'('+target['pmobileno']+')';
        let unlearned = target['unlearned'];
        let up = target['up'];
        chartHtml +=`
        <td class="col-2">${name}</td>
        <td class="col-2">${mobileno} </td>
        <td class="col-3">${parent_name_mobileno}</td>
        <td class="col-2">${make_recobook(target['reco_book_code'])} </td>
        <td class="col-2">${unlearned}(${up}%)</td><br>
        <td class="col-1"> <button class="modal-tbody-btn" data-bs-toggle="modal" data-bs-target="#consultinghistory" onclick="get_consulting_history(${register_no})">ğŸ“</button><br>
        `;
    } 
    $("#s_data").html(chartHtml);
}

function paging(totalData, dataPerPage, pageCount, currentPage, data_list, b_id) {
    totalPage = Math.ceil(totalData / dataPerPage); //ì´ í˜ì´ì§€ ìˆ˜

    if (totalPage < pageCount) {
        pageCount = totalPage;
    }

    let pageGroup = Math.ceil(currentPage / pageCount); // í˜ì´ì§€ ê·¸ë£¹ 1/10 1~10ê¹Œì§€ëŠ” '1' , 11~20 ê¹Œì§€ëŠ” 2 , 21~30ê¹Œì§€ëŠ” 3 
    let last = pageGroup * pageCount; //í™”ë©´ì— ë³´ì—¬ì§ˆ ë§ˆì§€ë§‰ í˜ì´ì§€ ë²ˆí˜¸

    if (last > totalPage) {
        last = totalPage;
    }
    let first = last - (pageCount - 1); //í™”ë©´ì— ë³´ì—¬ì§ˆ ì²«ë²ˆì§¸ í˜ì´ì§€ ë²ˆí˜¸
    let next = last + 1;
    let prev = first - 1;

    let pageHtml = "";

    if (prev > 0) {
        pageHtml += "<li><a class='cursor-pointer' id='prev'> ì´ì „ </a></li>";
    }

    //í˜ì´ì§• ë²ˆí˜¸ í‘œì‹œ 
    for (var i = first; i <= last; i++) {
        if (currentPage == i) {
            pageHtml +=
                "<li class='on'><a class='cursor-pointer' id='" + i + "'>" + i + "</a></li>";
        } else {
            pageHtml += "<li><a class='cursor-pointer' id='" + i + "'>" + i + "</a></li>";
        }
    }

    if (last < totalPage) {
        pageHtml += "<li><a class='cursor-pointer' id='next' > ë‹¤ìŒ </a></li>";
    }

    $("#pagingul").html(pageHtml);
    let displayCount = "";
    displayCount = " ì›ìƒ ëª…ë‹¨ 1 - " + totalPage + " í˜ì´ì§€ / " + totalData + "ê±´";
    $("#displayCount").text(displayCount);

    //í˜ì´ì§• ë²ˆí˜¸ í´ë¦­ ì´ë²¤íŠ¸ 
    $("#pagingul li a").click(function () {
        let $id = $(this).attr("id");
        selectedPage = $(this).text();

        if ($id == "next") selectedPage = next;
        if ($id == "prev") selectedPage = prev;

        //ì „ì—­ë³€ìˆ˜ì— ì„ íƒí•œ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ë‹´ëŠ”ë‹¤...
        globalCurrentPage = selectedPage;

        //í˜ì´ì§• í‘œì‹œ ì¬í˜¸ì¶œ
        paging(totalData, dataPerPage, pageCount, selectedPage, data_list,b_id);
        //ê¸€ ëª©ë¡ í‘œì‹œ ì¬í˜¸ì¶œ
        displayData(totalData, selectedPage, dataPerPage,data_list,b_id);
    });
}

function post_comment(q_id,is_coco){
    let comment_contents = ''
    if(is_coco == 0 ){
        comment_contents = $('#comment_contents').val()
    }else{
        comment_contents = $(`#comment_contents${is_coco}`).val()
    }
    if((comment_contents.length == 0)){
        alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”')
    }
    $.ajax({
            type: "POST",
			url:'/common/comment/'+q_id+'/'+is_coco,
			// data: JSON.stringify(jsonData), // String -> json í˜•íƒœë¡œ ë³€í™˜
            data: {
                comment_contents:comment_contents,
            },
            success: function (response) {{
				alert(response["result"])
                get_question_detail(q_id)    
			}}
		})
}

// ë¬¸ì˜ ì‚­ì œ í•¨ìˆ˜ 
async function delete_question(q_id){
    var con_val = confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')
    if(con_val == true){
    await $.ajax({
        type: 'POST',
        url: '/common/delete_question/' + q_id ,
        data: {},
        success: function(data){
            alert(data)
            history.go(0)
        },
        error: function(xhr, status, error){
            alert(xhr.responseText);
        }
    })
    get_consulting()
    }
}

